---
title: "Predicting Performance in the NBA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include = FALSE}
#install.packages("readxl")
library(readxl)
#install.packages("ggplot2")
library(ggplot2)
# install.packages("caret",
#                  repos = "http://cran.r-project.org",
#                  dependencies = c("Depends","Imports","Suggests"))
library(caret)
#install.packages("corrplot")
library(corrplot)
#install.packages("e1071")
library(e1071)
#install.packages("RANN")
library(RANN)
#install.packages("randomForest")
library(randomForest)
#install.packages("skimr")
library(skimr)
#install.packages("dplyr")
library(dplyr)
#install.packages("plotly")
library(plotly)
```

```{r data, include = FALSE, cache = TRUE}
source("Scripts/Wrangling.R")
source("Scripts/Preprocessing.R")
```

```{r modeling, include = FALSE, cache = TRUE}
source("Scripts/RandomForest.R")
```

```{r pred, include = FALSE}
predictions <- data.frame(Player = df_pred$Player,
                          Year = df_pred$Year_t1+1,
                          Pos = df_pred$Pos_t1,
                          y = y_test,
                          y_rf_mean = rfPred) %>% 
  mutate(error_rf_mean = y_rf_mean - y) %>% 
  mutate_if(is.factor, as.character)

predictions_training <- data.frame(Player = df[trainingRow, ]$Player,
                                   Year = df[trainingRow, ]$Year_t1+1,
                                   Pos = df[trainingRow, ]$Pos_t1,
                                   y = y_train,
                                   y_rf_mean = predict(rf)) %>% 
  mutate(error_rf = y_rf_mean - y)
```

## Predictions Player Performance {.tabset .tabset-fade .tabset-pills}

### Test data

The test data has `r length(predictions$Player)` observations with mean y of `r round(mean(predictions$y),2)` and standard deviation of `r round(sd(predictions$y),2)`.

```{r test data, echo = FALSE, warning = FALSE}

predictions$y_rf_mean <- round(predictions$y_rf_mean,2)

p <- ggplot(predictions, aes(x=y_rf_mean, y = y, color = Pos,
                             text = paste0(Player, " ", Year))) +
  geom_jitter()+
  geom_abline(linetype = 2)+
  scale_x_continuous(breaks = seq(0,15,1))+
  scale_y_continuous(breaks = seq(0,15,1))+
  theme_bw()


ggplotly(p)
```

### Training data

The test data has `r length(predictions_training$Player)` observations with mean y of `r round(mean(predictions_training$y),2)` and standard deviation of `r round(sd(predictions_training$y),2)`.

```{r training data, echo = FALSE, warning = FALSE}

predictions_training$y_rf_mean <- round(predictions_training$y_rf_mean,2)

q <- ggplot(predictions_training, aes(x=y_rf_mean, y = y, color = Pos,
                             text = paste0(Player, " ", Year))) +
  geom_jitter()+
  geom_abline(linetype = 2)+
  scale_x_continuous(breaks = seq(0,15,1))+
  scale_y_continuous(breaks = seq(0,15,1))+
  theme_bw()


ggplotly(q)
```

## Testing 2017/2018 season {.tabset .tabset-fade .tabset-pills}

```{r testing 2018, include = FALSE, cache = TRUE}
source("Scripts/Preprocessing_test2018.R")

source("Scripts/RandomForest.R")

source("Scripts/Rookies.R")

source("Scripts/Team_Records.R")

predictions_2018 <- data.frame(Player = df_pred$Player,
                          Year = df_pred$Year_t1+1,
                          Pos = df_pred$Pos_t1,
                          y = y_test,
                          y_rf_mean = rfPred) %>% 
  mutate(error_rf_mean = y_rf_mean - y) %>% 
  mutate_if(is.factor, as.character)


```

### Player Performance

```{r test data 2018, echo = FALSE, warning = FALSE}

predictions_2018$y_rf_mean <- round(predictions_2018$y_rf_mean,2)

p <- ggplot(predictions_2018, aes(x=y_rf_mean, y = y, color = Pos,
                             text = paste0(Player, " ", Year))) +
  geom_jitter()+
  geom_abline(linetype = 2)+
  scale_x_continuous(breaks = seq(0,15,1))+
  scale_y_continuous(breaks = seq(0,15,1))+
  theme_bw()


ggplotly(p)
```

### Team Performance

```{r teams 2018, include = FALSE}
adv2018 <- read_excel("Data/2018_adv.xlsx") %>% 
  subset(Tm != "TOT") %>% 
  group_by(Player) %>% 
  top_n(n=1,G)

df2018 <- merge(predictions_2018, adv2018, by = "Player") %>% 
  dplyr::select(Player, Team = Tm, G, MP, vorp = VORP, prediction_vorp = y_rf_mean)

rookies_2018 <- df_rookies %>% 
  filter(Year == 2018)

rookies_2018 <- merge(rookies_2018, adv2018, by = "Player") %>% 
  dplyr::select(Player, Team = Tm.y, G, MP, vorp = VORP, prediction_vorp = vorp_pred)

df2018 <- rbind(df2018,rookies_2018)

df_2018_Tm <- df2018 %>% 
  group_by(Team) %>% 
  dplyr::summarize(vorp = sum(prediction_vorp)) 

df_2018_Tm$wins_pred = predict(lm_teams, newdata = df_2018_Tm)

teams2018 <- subset(teams_all, teams_all$Year == 2018) %>% 
  dplyr::select(Team, Wins, VORP = vorp)

df_2018_Tm <- merge(df_2018_Tm, teams2018, by = "Team")
```

```{r team performance 2018, echo = FALSE, warning = FALSE}
df_2018_Tm$Wins_pred = round(df_2018_Tm$wins_pred,0)

q <- ggplot(df_2018_Tm, aes(x=Wins_pred, y = Wins, text = Team))+
  geom_point()+
  # geom_text(aes(label = Team), vjust = -1)+
  geom_abline(linetype = 2)+
  scale_x_continuous(breaks = seq(0,70,5))+
  scale_y_continuous(breaks = seq(0,70,5))+
  theme_bw()

ggplotly(q)
```
